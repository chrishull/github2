Launch an instance¶



===========================================
Create virtual networks
http://docs.openstack.org/liberty/install-guide-rdo/launch-instance.html#create-virtual-networks

===========================================
Create Public Provider Network

Make sure you have external_network_bridge defined in your L3 agent as an empty value.

Then your external network should be created with the provider type of 'flat' 
and the physical network corresponding to the one you have defined in your bridge 
mappings in the L2 agent  that attaches to the bridge going to your external physical 
network. 

neutron net-create public --shared --provider:physical_network public \
   --provider:network_type flat
   
[root@maersk src]# source admin-openrc.sh 
neutron net-create public --shared --provider:physical_network public \
   --provider:network_type flat
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | True                                 |
| id                        | be6e920a-51aa-4293-bb95-7ac38aab9df6 |
| mtu                       | 0                                    |
| name                      | public                               |
| port_security_enabled     | True                                 |
| provider:network_type     | flat                                 |
| provider:physical_network | public                               |
| provider:segmentation_id  |                                      |
| router:external           | False                                |
| shared                    | True                                 |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tenant_id                 | fdf3f98a9b0c4e9e94603d8a84ea41a8     |
+---------------------------+--------------------------------------+
[root@maersk src]# 




--- Create a subnet on the network:

Replace START_IP_ADDRESS and END_IP_ADDRESS with the first and last IP address of the range within 
the subnet that you want to allocate for instances. This range must not include any 
existing active IP addresses.

Example
neutron subnet-create public 203.0.113.0/24 --name public \
  --allocation-pool start=203.0.113.101,end=203.0.113.200 \
  --dns-nameserver 8.8.4.4 --gateway 203.0.113.1  
  
[root@maersk src]# cat /etc/resolv.conf 
; generated by /usr/sbin/dhclient-script
search attlocal.net
nameserver 172.22.10.254

cat ifcfg-enp3s0
GATEWAY=172.22.10.254
DNS1=172.22.10.254

neutron subnet-create public 172.22.10.0/24 --name public \
   --allocation-pool start=172.22.10.10,end=172.22.10.90 \
   --dns-nameserver 172.22.10.254 --gateway 172.22.10.254 --enable_dhcp False
   
Created a new subnet:
+-------------------+--------------------------------------------------+
| Field             | Value                                            |
+-------------------+--------------------------------------------------+
| allocation_pools  | {"start": "172.22.10.10", "end": "172.22.10.90"} |
| cidr              | 172.22.10.0/24                                   |
| dns_nameservers   | 172.22.10.254                                    |
| enable_dhcp       | True                                             |
| gateway_ip        | 172.22.10.254                                    |
| host_routes       |                                                  |
| id                | f227734a-eca3-4472-81f6-620e1bf1fac9             |
| ip_version        | 4                                                |
| ipv6_address_mode |                                                  |
| ipv6_ra_mode      |                                                  |
| name              | public                                           |
| network_id        | be6e920a-51aa-4293-bb95-7ac38aab9df6             |
| subnetpool_id     |                                                  |
| tenant_id         | fdf3f98a9b0c4e9e94603d8a84ea41a8                 |
+-------------------+--------------------------------------------------+

===========================================
Create the private project network
http://docs.openstack.org/liberty/install-guide-rdo/launch-instance-networks-private.html
  

source demo-openrc.sh

neutron net-create private
Created a new network:
+-----------------------+--------------------------------------+
| Field                 | Value                                |
+-----------------------+--------------------------------------+
| admin_state_up        | True                                 |
| id                    | 28ca326a-8443-4c1c-b288-48920a1eefbe |
| mtu                   | 0                                    |
| name                  | private                              |
| port_security_enabled | True                                 |
| router:external       | False                                |
| shared                | False                                |
| status                | ACTIVE                               |
| subnets               |                                      |
| tenant_id             | 7813be77b1de4196b1c6b77006afa21c     |
+-----------------------+--------------------------------------+
neutron subnet-create private 192.168.10.0/24 \
     --name private --dns-nameserver 172.22.10.254 --gateway 192.168.10.1
Created a new subnet:
+-------------------+----------------------------------------------------+
| Field             | Value                                              |
+-------------------+----------------------------------------------------+
| allocation_pools  | {"start": "192.168.10.2", "end": "192.168.10.254"} |
| cidr              | 192.168.10.0/24                                    |
| dns_nameservers   | 172.22.10.254                                      |
| enable_dhcp       | True                                               |
| gateway_ip        | 192.168.10.1                                       |
| host_routes       |                                                    |
| id                | eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92               |
| ip_version        | 4                                                  |
| ipv6_address_mode |                                                    |
| ipv6_ra_mode      |                                                    |
| name              | private                                            |
| network_id        | 28ca326a-8443-4c1c-b288-48920a1eefbe               |
| subnetpool_id     |                                                    |
| tenant_id         | 7813be77b1de4196b1c6b77006afa21c                   |
+-------------------+----------------------------------------------------+






====
Create a router
====

Private project networks connect to public provider networks using a virtual router. 
Each router contains an interface to at least one private project network and a gateway 
on a public provider network.

source admin

  
XXX ROUTER ALWYS DOWN?   Set Private BEFORE PUBLIC?
https://ask.openstack.org/en/question/8290/port-on-router-to-public-gateway-always-down/

[root@maersk src]# source admin-openrc.sh 
[root@maersk src]# neutron net-update public --router:external  
Updated network: public
[root@maersk src]# source demo-openrc.sh 
[root@maersk src]# neutron router-create router
Created a new router:
+-----------------------+--------------------------------------+
| Field                 | Value                                |
+-----------------------+--------------------------------------+
| admin_state_up        | True                                 |
| external_gateway_info |                                      |
| id                    | 52ca91cb-df23-4593-bb95-ea9f1fc33e99 |
| name                  | router                               |
| routes                |                                      |
| status                | ACTIVE                               |
| tenant_id             | 7813be77b1de4196b1c6b77006afa21c     |
+-----------------------+--------------------------------------+
[root@maersk src]# neutron router-interface-add router private
Added interface 5b25c4df-0c83-4ef2-bed6-6e854cf66af6 to router router.
[root@maersk src]# neutron router-gateway-set router public
Set gateway for router router
[root@maersk src]# source admin-openrc.sh
[root@maersk src]# ip netns
qrouter-52ca91cb-df23-4593-bb95-ea9f1fc33e99 (id: 2)
qdhcp-28ca326a-8443-4c1c-b288-48920a1eefbe (id: 1)
qdhcp-be6e920a-51aa-4293-bb95-7ac38aab9df6 (id: 0)
[root@maersk src]# neutron router-port-list router
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| id                                   | name | mac_address       | fixed_ips                                                                           |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| 5b25c4df-0c83-4ef2-bed6-6e854cf66af6 |      | fa:16:3e:d5:62:14 | {"subnet_id": "eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92", "ip_address": "192.168.10.1"} |
| d1dfcc09-9da6-4366-8080-c73d48286036 |      | fa:16:3e:b7:d2:22 | {"subnet_id": "f227734a-eca3-4472-81f6-620e1bf1fac9", "ip_address": "172.22.10.11"} |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
[root@maersk src]# ping -c 4 172.22.10.11
PING 172.22.10.11 (172.22.10.11) 56(84) bytes of data.
From 172.22.10.99 icmp_seq=1 Destination Host Unreachable
From 172.22.10.99 icmp_seq=2 Destination Host Unreachable
From 172.22.10.99 icmp_seq=3 Destination Host Unreachable
From 172.22.10.99 icmp_seq=4 Destination Host Unreachable

--- 172.22.10.11 ping statistics ---
4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 2999ms
pipe 4
[root@maersk src]# 

===============================================================
Back to Launch an Instance

http://docs.openstack.org/liberty/install-guide-rdo/launch-instance.html#add-security-group-rules


Generate a key pair¶



Launch an instance


[root@maersk src]# neutron net-list  
+--------------------------------------+---------+------------------------------------------------------+
| id                                   | name    | subnets                                              |
+--------------------------------------+---------+------------------------------------------------------+
| 28ca326a-8443-4c1c-b288-48920a1eefbe | private | eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92 192.168.10.0/24 |
| be6e920a-51aa-4293-bb95-7ac38aab9df6 | public  | f227734a-eca3-4472-81f6-620e1bf1fac9 172.22.10.0/24  |
+--------------------------------------+---------+------------------------------------------------------+
[root@maersk src]# nova secgroup-list
+--------------------------------------+---------+------------------------+
| Id                                   | Name    | Description            |
+--------------------------------------+---------+------------------------+
| a76c3568-7f0c-4e57-903b-669f6911eb0d | default | Default security group |
+--------------------------------------+---------+------------------------+



nova boot --flavor m1.tiny --image cirros --nic net-id=be6e920a-51aa-4293-bb95-7ac38aab9df6 \
  --security-group default --key-name mykey public-instance
  
  
  


Thus far.  The Router won't PING and is always DOWN.
So here's how you tear down the nets and start over after googling for a day.

========================================================================================================
========================================================================================================
========================================================================================================

Delete Networks


http://egonzalez.org/delete-openstack-neutron-networks-solution-to-unable-to-complete-operation-on-subnet/



[root@maersk src]# source admin-openrc.sh 
[root@maersk src]# 
[root@maersk src]# neutron router-list
+--------------------------------------+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+-------+
| id                                   | name   | external_gateway_info                                                                                                                                                                    | distributed | ha    |
+--------------------------------------+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+-------+
| 52ca91cb-df23-4593-bb95-ea9f1fc33e99 | router | {"network_id": "be6e920a-51aa-4293-bb95-7ac38aab9df6", "enable_snat": true, "external_fixed_ips": [{"subnet_id": "f227734a-eca3-4472-81f6-620e1bf1fac9", "ip_address": "172.22.10.11"}]} | False       | False |
+--------------------------------------+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+-------+
[root@maersk src]# neutron router-gateway-clear 52ca91cb-df23-4593-bb95-ea9f1fc33e99
Removed gateway from router 52ca91cb-df23-4593-bb95-ea9f1fc33e99
[root@maersk src]# neutron router-port-list 52ca91cb-df23-4593-bb95-ea9f1fc33e99  
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| id                                   | name | mac_address       | fixed_ips                                                                           |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| 5b25c4df-0c83-4ef2-bed6-6e854cf66af6 |      | fa:16:3e:d5:62:14 | {"subnet_id": "eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92", "ip_address": "192.168.10.1"} |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
[root@maersk src]# neutron router-interface-delete  52ca91cb-df23-4593-bb95-ea9f1fc33e99 5b25c4df-0c83-4ef2-bed6-6e854cf66af6  
Unable to find subnet with name '5b25c4df-0c83-4ef2-bed6-6e854cf66af6'
[root@maersk src]# neutron router-subnet-list 52ca91cb-df23-4593-bb95-ea9f1fc33e99  
Unknown command [u'router-subnet-list', u'52ca91cb-df23-4593-bb95-ea9f1fc33e99']
[root@maersk src]# neutron router-interface-delete  52ca91cb-df23-4593-bb95-ea9f1fc33e99 eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92
Removed interface from router 52ca91cb-df23-4593-bb95-ea9f1fc33e99.
[root@maersk src]# neutron router-delete 52ca91cb-df23-4593-bb95-ea9f1fc33e99  
Deleted router: 52ca91cb-df23-4593-bb95-ea9f1fc33e99
[root@maersk src]# neutron subnet-list
+--------------------------------------+---------+-----------------+----------------------------------------------------+
| id                                   | name    | cidr            | allocation_pools                                   |
+--------------------------------------+---------+-----------------+----------------------------------------------------+
| f227734a-eca3-4472-81f6-620e1bf1fac9 | public  | 172.22.10.0/24  | {"start": "172.22.10.10", "end": "172.22.10.40"}   |
| eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92 | private | 192.168.10.0/24 | {"start": "192.168.10.2", "end": "192.168.10.254"} |
+--------------------------------------+---------+-----------------+----------------------------------------------------+
[root@maersk src]# neutron subnet-delete f227734a-eca3-4472-81f6-620e1bf1fac9  
Unable to complete operation on subnet f227734a-eca3-4472-81f6-620e1bf1fac9. One or more ports have an IP allocation from this subnet.
[root@maersk src]# neutron port-list  
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| id                                   | name | mac_address       | fixed_ips                                                                           |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| 22307900-d514-4dc1-9134-1a0ff5056fed |      | fa:16:3e:18:2d:c6 | {"subnet_id": "f227734a-eca3-4472-81f6-620e1bf1fac9", "ip_address": "172.22.10.12"} |
| 6b44eb6d-5731-4111-8692-d65fe41bd599 |      | fa:16:3e:28:b3:10 | {"subnet_id": "eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92", "ip_address": "192.168.10.2"} |
| a0ecf115-5d5e-45c8-9287-4676a04e9593 |      | fa:16:3e:0a:30:e1 | {"subnet_id": "f227734a-eca3-4472-81f6-620e1bf1fac9", "ip_address": "172.22.10.13"} |
| f82ad7e7-37df-4855-b170-960cb72fb8cb |      | fa:16:3e:19:77:ca | {"subnet_id": "f227734a-eca3-4472-81f6-620e1bf1fac9", "ip_address": "172.22.10.10"} |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
[root@maersk src]# neutron port-delete  22307900-d514-4dc1-9134-1a0ff5056fed 
Port 22307900-d514-4dc1-9134-1a0ff5056fed cannot be deleted directly via the port API: has device owner network:floatingip
[root@maersk src]# neutron floatingip-list
+--------------------------------------+------------------+---------------------+---------+
| id                                   | fixed_ip_address | floating_ip_address | port_id |
+--------------------------------------+------------------+---------------------+---------+
| 1f697917-c6da-4bdb-bc98-c8e94f3effb5 |                  | 172.22.10.12        |         |
| 447faa9a-25d0-4559-93f2-5499c8def51e |                  | 172.22.10.13        |         |
| a0b8a122-ee01-40cd-91e6-473cacad1793 |                  | 172.22.10.10        |         |
+--------------------------------------+------------------+---------------------+---------+
[root@maersk src]# neutron floatingip-delete 1f697917-c6da-4bdb-bc98-c8e94f3effb5  
Deleted floatingip: 1f697917-c6da-4bdb-bc98-c8e94f3effb5
[root@maersk src]# neutron floatingip-delete 447faa9a-25d0-4559-93f2-5499c8def51e  
Deleted floatingip: 447faa9a-25d0-4559-93f2-5499c8def51e
[root@maersk src]# neutron floatingip-delete a0b8a122-ee01-40cd-91e6-473cacad1793  
Deleted floatingip: a0b8a122-ee01-40cd-91e6-473cacad1793
[root@maersk src]# neutron port-list
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| id                                   | name | mac_address       | fixed_ips                                                                           |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
| 6b44eb6d-5731-4111-8692-d65fe41bd599 |      | fa:16:3e:28:b3:10 | {"subnet_id": "eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92", "ip_address": "192.168.10.2"} |
+--------------------------------------+------+-------------------+-------------------------------------------------------------------------------------+
[root@maersk src]# neutron port-delete  6b44eb6d-5731-4111-8692-d65fe41bd599  
Deleted port: 6b44eb6d-5731-4111-8692-d65fe41bd599
[root@maersk src]# neutron net-list
+--------------------------------------+---------+------------------------------------------------------+
| id                                   | name    | subnets                                              |
+--------------------------------------+---------+------------------------------------------------------+
| be6e920a-51aa-4293-bb95-7ac38aab9df6 | public  | f227734a-eca3-4472-81f6-620e1bf1fac9 172.22.10.0/24  |
| 28ca326a-8443-4c1c-b288-48920a1eefbe | private | eb5550e2-4de5-4ca5-9d7e-9d6ffe86ce92 192.168.10.0/24 |
+--------------------------------------+---------+------------------------------------------------------+
[root@maersk src]# neutron net-delete be6e920a-51aa-4293-bb95-7ac38aab9df6  
Deleted network: be6e920a-51aa-4293-bb95-7ac38aab9df6
[root@maersk src]# neutron net-delete 28ca326a-8443-4c1c-b288-48920a1eefbe  
Deleted network: 28ca326a-8443-4c1c-b288-48920a1eefbe
[root@maersk src]# 


==============

Further Diagnostics

https://ask.openstack.org/en/question/52893/neutron-setting-incorrect-gateway/

https://bugs.launchpad.net/neutron/+bug/1404823

https://bugs.launchpad.net/neutron/+bug/1192883
All ports on public network are created and stay in state DOWN. 
The ports are actually up and traffic passes through them.



  